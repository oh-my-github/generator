{"version":3,"sources":["generator/src/nodegit_util.js"],"names":[],"mappings":"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","file":"generator/src/nodegit_util.js","sourcesContent":["/// <reference path=\"../../typings/node/node.d.ts\" />\n/// <reference path=\"../../typings/lodash/lodash.d.ts\" />\n/// <reference path=\"../../typings/fs-extra/fs-extra.d.ts\" />\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, Promise, generator) {\n    return new Promise(function (resolve, reject) {\n        generator = generator.call(thisArg, _arguments);\n        function cast(value) { return value instanceof Promise && value.constructor === Promise ? value : new Promise(function (resolve) { resolve(value); }); }\n        function onfulfill(value) { try { step(\"next\", value); } catch (e) { reject(e); } }\n        function onreject(value) { try { step(\"throw\", value); } catch (e) { reject(e); } }\n        function step(verb, value) {\n            var result = generator[verb](value);\n            result.done ? resolve(result.value) : cast(result.value).then(onfulfill, onreject);\n        }\n        step(\"next\", void 0);\n    });\n};\nlet nodegit = require(\"nodegit\");\nimport { Log } from \"./util\";\nfunction nodegitLog(message) {\n    Log.blue(\"  Running Git Command: \", message);\n}\nexport function addAllAndCommit(path, user, commitMessage, initial) {\n    return __awaiter(this, void 0, Promise, function* () {\n        nodegitLog(`git commit -a -m \"${commitMessage}\"`);\n        let repo = yield nodegit.Repository.open(path);\n        let index = yield repo.openIndex();\n        yield index.addAll();\n        yield index.write();\n        let oid = yield index.writeTree();\n        var author = nodegit.Signature.now(user, user);\n        var committer = nodegit.Signature.now(user, user);\n        if (initial)\n            return yield repo.createCommit(\"HEAD\", author, committer, commitMessage, oid, []);\n        let head = yield nodegit.Reference.nameToId(repo, \"HEAD\");\n        let parent = yield repo.getCommit(head);\n        return yield repo.createCommit(\"HEAD\", author, committer, commitMessage, oid, [parent]);\n    });\n}\nexport function checkoutGhPagesBranch(path, user) {\n    return __awaiter(this, void 0, Promise, function* () {\n        let repo = undefined;\n        /** initialize repository if not exist */\n        try {\n            repo = yield nodegit.Repository.open(path);\n        }\n        catch (error) {\n            nodegitLog(\"git init\");\n            repo = yield nodegit.Repository.init(path, 0);\n        }\n        let branch = undefined;\n        /** do initial commit if not exist */\n        try {\n            branch = yield repo.getCurrentBranch();\n        }\n        catch (error) {\n            yield addAllAndCommit(path, user, \"initial commit\", true);\n            repo = yield nodegit.Repository.open(path);\n            branch = yield repo.getCurrentBranch();\n        }\n        /** lookup gh-pages branch and create it if not exists */\n        try {\n            let ghPagesBranch = yield repo.getBranch(\"gh-pages\");\n        }\n        catch (error) {\n            nodegitLog(\"git branch gh-pages HEAD\");\n            let headCommit = yield repo.getHeadCommit();\n            yield repo.createBranch(\"gh-pages\", headCommit, 0, repo.defaultSignature(), \"message\");\n        }\n        /** checkout gh-pages */\n        let branchName = branch.name();\n        if (!branchName.endsWith(\"/gh-pages\")) {\n            nodegitLog(\"git checkout gh-pages\");\n            repo = yield nodegit.Repository.open(path);\n            return yield repo.checkoutBranch(\"gh-pages\", {\n                checkoutStrategy: nodegit.Checkout.STRATEGY.SAFE | nodegit.Checkout.STRATEGY.RECREATE_MISSING\n            });\n        }\n        return yield Promise.resolve();\n    });\n}\n/**\n * branchName: e.g 'gh-pages'\n * remoteName: e.g 'origin'\n * gitUrl: e.g 'git@github.com:1ambda/oh-my-github'\n */\nexport function push(path, branchName, remoteName, gitUrl) {\n    return __awaiter(this, void 0, Promise, function* () {\n        let repo = yield nodegit.Repository.open(path);\n        let remote = undefined;\n        try {\n            remote = yield nodegit.Remote.lookup(repo, remoteName);\n        }\n        catch (error) {\n            nodegitLog(`git remote add ${remoteName} ${nodegit.rl}`);\n            remote = yield nodegit.Remote.create(repo, remoteName, gitUrl);\n        }\n        nodegitLog(`git push origin ${branchName}:${branchName} --force`);\n        return yield remote.push([`+refs/heads/${branchName}:refs/heads/${branchName}`], { callbacks: {\n                credentials: function (url, userName) {\n                    return nodegit.Cred.sshKeyFromAgent(userName);\n                }\n            } });\n    });\n}\nexport function publish(user, repoName) {\n    return __awaiter(this, void 0, Promise, function* () {\n        let path = process.cwd();\n        let branchName = \"gh-pages\";\n        let remoteName = \"origin\";\n        let gitUrl = `git@github.com:${user}/${repoName}`;\n        let commitMessage = `Update profile (${(new Date).toISOString()})`;\n        yield checkoutGhPagesBranch(path, user);\n        yield addAllAndCommit(path, user, commitMessage, false);\n        yield push(path, branchName, remoteName, gitUrl);\n    });\n}\n"],"sourceRoot":"/source/"}